{"mappings":";;AAWA;IACE,MAAM,EAAE,MAAM,CAAC;IACf,cAAc,CAAC,EAAE,CAAC,IAAI,EAAE,QAAQ,KAAK,OAAO,CAAC,IAAI,CAAC,CAAC;IACnD,MAAM,EAAE,YAAY,CAAC;IACrB,SAAS,EAAE,YAAY,CAAC;IACxB,KAAK,EAAE,MAAM,CAAC;IACd,WAAW,EAAE,MAAM,CAAC;IACpB,aAAa,EAAE,MAAM,CAAC;IACtB,WAAW,CAAC,EAAE,MAAM,CAAC;CACtB;AAED;IACE,EAAE,EAAE,MAAM,CAAC;IACX,GAAG,EAAE,MAAM,CAAC;IACZ,IAAI,EAAE,MAAM,CAAC;IACb,KAAK,EAAE,MAAM,CAAC;CACf;AAuCD,4BAA4B,OAAO,EAAE,CAAC,QAAQ,EAAE,QAAQ,KAAK,OAAO,CAAC,IAAI,CAAC,cAA1B,QAAQ,KAAK,QAAQ,IAAI,CAAC,CAEzE;AAED,sCAAsC,IAAI,EAAE,SAAS,SAiDlB,QAAQ,WAAW,UAgCrD","sources":["src/src/steamOAuth.ts","src/steamOAuth.ts"],"sourcesContent":[null,"import { createRequestHandler, routeHandler } from '@ianlucas/http';\r\nimport * as express from 'express';\r\nimport * as session from 'express-session';\r\nimport * as passport from 'passport';\r\nimport * as fileStore from 'session-file-store';\r\n\r\nconst FileStore = fileStore(session);\r\nconst Strategy: any = require('passport-steam');\r\n\r\ntype doneHandler = (error: any, userId?: string) => void;\r\n\r\ninterface SteamSpec {\r\n  apiKey: string;\r\n  onAuthenticate?: (user: UserData) => Promise<void>;\r\n  onFail: routeHandler;\r\n  onSuccess: routeHandler;\r\n  realm: string;\r\n  sessionPath: string;\r\n  sessionSecret: string;\r\n  routePrefix?: string;\r\n}\r\n\r\nexport interface UserData {\r\n  id: string;\r\n  id2: string;\r\n  name: string;\r\n  photo: string;\r\n}\r\n\r\ninterface SteamProfile {\r\n  _json: {\r\n    avatarfull: string;\r\n    personaname: string;\r\n    steamid: string;\r\n  };\r\n}\r\n\r\nfunction replace(one: number, two: number) {\r\n  return one === 1 ? two : one;\r\n}\r\n\r\nfunction getUserData(profile: SteamProfile): UserData {\r\n  const data = profile._json;\r\n  const steamId = BigInt(data.steamid);\r\n  const universeId = replace(Number(steamId >> 56n), 0);\r\n  const accountId = Number(steamId & BigInt(0xffffffff));\r\n  const i1 = universeId;\r\n  const i2 = accountId & 1;\r\n  const i3 = Math.floor(accountId / 2);\r\n  const id2 = `STEAM_${i1}:${i2}:${i3}`;\r\n  return {\r\n    id: data.steamid,\r\n    id2,\r\n    name: data.personaname,\r\n    photo: data.avatarfull\r\n  };\r\n}\r\n\r\nfunction serializeUser(id: any, done: doneHandler) {\r\n  done(null, id);\r\n}\r\n\r\nfunction deserializeUser(id: string, done: doneHandler) {\r\n  done(null, id);\r\n}\r\n\r\nexport function useUserData(handler: (userData: UserData) => Promise<void>) {\r\n  return handler;\r\n}\r\n\r\nexport default function useSteamOAuth(spec: SteamSpec) {\r\n  spec.routePrefix = spec.routePrefix || '';\r\n\r\n  async function validate(\r\n    identifier: string,\r\n    profile: SteamProfile,\r\n    done: doneHandler\r\n  ) {\r\n    try {\r\n      const userData = getUserData(profile);\r\n      if (spec.onAuthenticate) {\r\n        await spec.onAuthenticate(userData);\r\n      }\r\n      return done(null, userData.id);\r\n    } catch (error) {\r\n      return done(error);\r\n    }\r\n  }\r\n\r\n  function authenticate(\r\n    request: express.Request,\r\n    response: express.Response,\r\n    error: any,\r\n    userId: string\r\n  ) {\r\n    if (error) {\r\n      return createRequestHandler(spec.onFail)(request, response, error);\r\n    }\r\n    if (!userId) {\r\n      return createRequestHandler(spec.onFail)(request, response);\r\n    }\r\n    request.logIn(userId, (loginError) => {\r\n      if (loginError) {\r\n        return createRequestHandler(spec.onFail)(request, response, loginError);\r\n      }\r\n      return createRequestHandler(spec.onSuccess)(request, response);\r\n    });\r\n  }\r\n\r\n  function handlePostLogin(\r\n    request: express.Request,\r\n    response: express.Response,\r\n    next: express.NextFunction\r\n  ) {\r\n    passport.authenticate('steam', (error, userId) => {\r\n      authenticate(request, response, error, userId);\r\n    })(request, response, next);\r\n  }\r\n\r\n  return function steamPlugin(app: express.Application) {\r\n    const options = {\r\n      apiKey: spec.apiKey,\r\n      returnURL: `${spec.realm}/__postlogin__`,\r\n      realm: spec.realm\r\n    };\r\n\r\n    const steamStrategy = new Strategy(options, validate);\r\n    const handleLogin = passport.authenticate('steam');\r\n\r\n    const fileStoreOptions = {\r\n      path: spec.sessionPath || './sessions'\r\n    };\r\n\r\n    const sessionHandler = session({\r\n      secret: spec.sessionSecret,\r\n      resave: true,\r\n      saveUninitialized: true,\r\n      store: new FileStore(fileStoreOptions)\r\n    });\r\n\r\n    app.use(sessionHandler);\r\n    app.use(passport.initialize());\r\n    app.use(passport.session());\r\n\r\n    passport.serializeUser(serializeUser);\r\n    passport.deserializeUser(deserializeUser);\r\n    passport.use(steamStrategy);\r\n\r\n    app.get(spec.routePrefix + '/__login__', handleLogin);\r\n    app.get(spec.routePrefix + '/__postlogin__', handlePostLogin);\r\n  };\r\n}\r\n"],"names":[],"version":3,"file":"types.d.ts.map"}